<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¯æ„›æœå­—éŠæˆ²ï¼ˆæ–¹å‘é™å®šï¼šâ†“â†˜â†™ï¼‰</title>
  <style>
    :root{
      --bg:#fff7fb;
      --ink:#2b2b2b;
      --muted:#6b6b6b;
      --primary:#ff6fb1;
      --primary2:#8a7dff;
      --ok:#2fbf71;
      --gridbg:#fff;
      --gridline:#f1e7f3;
      --shadow: 0 8px 24px rgba(0,0,0,.08);
      --radius:18px;
      --cell:44px;
      --font: system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--ink);
      background: radial-gradient(1200px 600px at 20% 0%, #ffe2f1 0%, transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, #e8e5ff 0%, transparent 55%),
                  var(--bg);
      min-height:100vh;
    }
    header{
      padding:18px 16px 10px;
      max-width:1200px;
      margin:0 auto;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: conic-gradient(from 180deg, var(--primary), #ffd1e7, var(--primary2), #d9d4ff, var(--primary));
      box-shadow: var(--shadow);
    }
    h1{ font-size:18px; margin:0; letter-spacing:.5px; }
    .sub{ font-size:12px; color:var(--muted); margin-top:2px; }
    .top-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    button{
      border:0; border-radius:14px; padding:10px 12px;
      background:#fff; box-shadow:0 6px 18px rgba(0,0,0,.06);
      cursor:pointer; font-weight:700; color:var(--ink);
      transition: transform .08s ease, box-shadow .08s ease;
      user-select:none;
      white-space:nowrap;
    }
    button:active{ transform: translateY(1px); box-shadow:0 4px 12px rgba(0,0,0,.06); }
    .btn-primary{ background: linear-gradient(135deg, var(--primary), #ff9ccc); color:#fff; }
    .btn-ghost{ background: rgba(255,255,255,.72); backdrop-filter: blur(10px); }
    .btn-warn{ background: linear-gradient(135deg, #ffd7a8, #fff0c9); }
    .btn-danger{ background: linear-gradient(135deg, #ffb7c9, #ffe3ea); }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:999px;
      background: rgba(255,255,255,.72);
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      font-weight:800;
    }
    .timer-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:999px;
      background: rgba(255,255,255,.72);
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      font-weight:900;
    }
    .timer-pill .tlabel{ font-size:12px; color:var(--muted); font-weight:800; }
    .timer-pill .tvalue{ font-variant-numeric: tabular-nums; letter-spacing:.5px; }
    .switch{ display:inline-flex; align-items:center; gap:8px; font-size:13px; color:var(--ink); }
    .switch input{ width:18px; height:18px; accent-color: var(--primary); }

    main{
      max-width:1200px;
      margin:0 auto;
      padding:10px 16px 24px;
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
    }
    @media (max-width: 980px){ main{ grid-template-columns:1fr; } }

    .card{
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.6);
    }
    .card-h{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(0,0,0,.05);
    }
    .card-h .title{ font-weight:900; display:flex; align-items:center; gap:10px; }
    .badge{
      display:inline-flex;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(138,125,255,.14);
      color:#3b2fd9;
      font-size:12px;
      font-weight:900;
    }
    .card-b{ padding:14px; }

    .lesson-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    .lesson-btn{
      text-align:left;
      border-radius:16px;
      padding:12px 12px;
      background:#fff;
      border: 1px solid rgba(0,0,0,.06);
    }
    .lesson-btn strong{ display:block; font-size:14px; }
    .lesson-btn span{ display:block; font-size:12px; color:var(--muted); margin-top:4px; }
    .lesson-btn.active{
      background: linear-gradient(135deg, rgba(255,111,177,.18), rgba(138,125,255,.16));
      border-color: rgba(255,111,177,.4);
    }

    .words{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:8px;
      margin-top:8px;
    }
    .w{
      padding:10px 10px;
      border-radius:14px;
      background:#fff;
      border: 1px solid rgba(0,0,0,.06);
      display:flex; align-items:center; gap:10px; justify-content:space-between;
      font-weight:800;
    }
    .w.found{
      border-color: rgba(47,191,113,.55);
      background: rgba(47,191,113,.12);
    }
    .w .tick{
      width:18px;height:18px;border-radius:6px;
      background: rgba(0,0,0,.06);
      display:inline-flex; align-items:center; justify-content:center;
      font-size:12px;
    }
    .w.found .tick{ background: rgba(47,191,113,.20); color: var(--ok); }

    .grid-wrap{ display:flex; gap:14px; align-items:stretch; flex-wrap:wrap; }
    .grid-shell{ position:relative; display:inline-block; }
    .grid{
      display:grid;
      grid-template-columns: repeat(var(--n), var(--cell));
      grid-template-rows: repeat(var(--n), var(--cell));
      background: var(--gridbg);
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,.06);
      padding:10px;
      position:relative;
      touch-action:none;
      user-select:none;
      box-shadow: 0 10px 26px rgba(0,0,0,.06);
    }
    .grid.paused{
      pointer-events:none;
      filter: grayscale(1) brightness(.96);
      opacity:.75;
    }
    .pause-overlay{
      position:absolute;
      inset:0;
      border-radius:18px;
      display:none;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:16px;
      background: rgba(255,255,255,.62);
      backdrop-filter: blur(6px);
      border: 1px dashed rgba(0,0,0,.10);
      box-shadow: 0 10px 26px rgba(0,0,0,.08);
    }
    .pause-overlay.show{ display:flex; }
    .pause-overlay .box{
      background: rgba(255,255,255,.90);
      border: 1px solid rgba(0,0,0,.06);
      border-radius:16px;
      padding:12px 14px;
      box-shadow: 0 10px 26px rgba(0,0,0,.06);
      max-width: 320px;
    }
    .pause-overlay .box strong{ display:block; font-size:16px; }
    .pause-overlay .box div{ margin-top:6px; font-size:12px; color:var(--muted); line-height:1.5; }

    .cell{
      width:var(--cell); height:var(--cell);
      display:flex; align-items:center; justify-content:center;
      border-radius: 12px;
      border: 1px solid var(--gridline);
      font-weight:900;
      font-size:18px;
      background:#fff;
      transition: transform .06s ease;
    }
    .cell:hover{ transform: translateY(-1px); }
    .cell.sel{
      background: rgba(255,111,177,.20);
      border-color: rgba(255,111,177,.45);
    }
    .cell.found{
      background: rgba(138,125,255,.18);
      border-color: rgba(138,125,255,.45);
    }
    .status{
      margin-top:10px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      font-size:13px;
      color:var(--muted);
    }
    .status strong{ color:var(--ink); }

    .toast{
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.85);
      border:1px solid rgba(0,0,0,.06);
      box-shadow: 0 8px 22px rgba(0,0,0,.08);
      position:fixed;
      left:16px; bottom:16px;
      max-width: min(520px, calc(100vw - 32px));
      display:none;
      z-index:999;
    }
    .toast.show{ display:block; }
    .toast strong{ display:block; margin-bottom:2px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .small{ font-size:12px; color:var(--muted); line-height:1.45; }
    textarea{
      width:100%;
      min-height:170px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.10);
      padding:10px 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      background: rgba(255,255,255,.85);
      outline:none;
    }
    input[type="text"], select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.10);
      padding:10px 12px;
      background: rgba(255,255,255,.85);
      font-weight:800;
      outline:none;
    }
    select{ font-weight:800; }
    .divider{ height:1px; background: rgba(0,0,0,.06); margin:12px 0; }
    .hint{
      display:inline-flex; gap:6px; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,176,32,.14);
      color: #7a4b00;
      font-size:12px;
      font-weight:900;
    }
    .okpill{
      display:inline-flex; gap:6px; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(47,191,113,.14);
      color: #116437;
      font-size:12px;
      font-weight:900;
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>å¯æ„›æœå­—éŠæˆ²ï¼ˆæ–¹å‘é™å®šï¼šâ†“ â†˜ â†™ï¼‰</h1>
      <div class="sub">åªå…è¨±ã€Œç”±ä¸Šè€Œä¸‹ã€å·¦ä¸Šå¾€å³ä¸‹ã€å³ä¸Šå¾€å·¦ä¸‹ã€ï¼›å–®é¡ŒæˆåŠŸèˆ‡å…¨å®Œæˆæœ‰ä¸åŒéŸ³æ•ˆã€‚</div>
    </div>
  </div>

  <div class="top-actions">
    <span class="pill" id="pillLesson">å°šæœªé¸èª²</span>

    <span class="timer-pill" title="è¨ˆæ™‚å™¨">
      <span class="tlabel">â± è¨ˆæ™‚</span>
      <span class="tvalue" id="timerText">00:00</span>
    </span>
    <button class="btn-ghost" id="btnTimerToggle" title="æš«åœ / ç¹¼çºŒ">æš«åœ</button>
    <button class="btn-warn" id="btnTimerReset" title="é‡æ–°é–‹å§‹è¨ˆæ™‚ï¼ˆæ­¸é›¶ï¼‰">é‡è¨­è¨ˆæ™‚</button>

    <label class="switch pill" title="æ‰¾åˆ°èªè©å¾Œæœ—è®€ï¼ˆéœ€ç€è¦½å™¨æ”¯æ´èªéŸ³åˆæˆï¼‰">
      <input type="checkbox" id="ttsToggle" />
      æœ—è®€èªè©
    </label>
    <button class="btn-ghost" id="btnNew" title="é‡æ–°ç”ŸæˆåŒä¸€èª²çš„å­—æ ¼">é‡æ–°ç”Ÿæˆ</button>
    <button class="btn-primary" id="btnReset" title="æ¸…é™¤æ‰¾åˆ°çš„ç‹€æ…‹ä¸¦é‡æ–°é–‹å§‹">é‡æ–°é–‹å§‹</button>
  </div>
</header>

<main>
  <section class="card">
    <div class="card-h">
      <div class="title">
        <span>ğŸ” å­—æ ¼å€</span>
        <span class="badge" id="badgeSize">â€”</span>
      </div>
      <div class="row">
        <span class="hint" title="æ“ä½œæç¤º">åªå…è¨± â†“ â†˜ â†™</span>
        <span class="okpill" id="pillProgress" style="display:none;">å®Œæˆï¼</span>
      </div>
    </div>

    <div class="card-b">
      <div class="grid-wrap">
        <div>
          <div class="grid-shell">
            <div class="grid" id="grid" aria-label="æœå­—æ–¹æ ¼"></div>
            <div class="pause-overlay" id="pauseOverlay" aria-hidden="true">
              <div class="box">
                <strong>å·²æš«åœ</strong>
                <div>å­—æ ¼å·²é–ä½ã€‚è«‹æŒ‰ä¸Šæ–¹ã€Œç¹¼çºŒã€å¾Œå†æ“ä½œã€‚</div>
              </div>
            </div>
          </div>

          <div class="status">
            <span>å·²æ‰¾åˆ°ï¼š<strong id="foundCount">0</strong>/<strong id="totalCount">0</strong></span>
            <span>â€”</span>
            <span id="statusHint">æ–¹å‘ï¼šâ†“ã€â†˜ã€â†™ï¼ˆä¸æ¥å—åå‘èˆ‡æ°´å¹³ï¼‰</span>
          </div>

          <div class="status" style="margin-top:6px;">
            <span>é¡Œç›®æç¤ºï¼š<strong id="questionText">â€”</strong></span>
          </div>
        </div>

        <div style="flex:1; min-width: 260px;">
          <div class="card" style="box-shadow:none; background: rgba(255,255,255,.65);">
            <div class="card-h">
              <div class="title">ğŸ“Œ æœ¬èª²èªè©</div>
              <div class="small" id="lessonMeta">â€”</div>
            </div>
            <div class="card-b">
              <div class="small" id="lessonQuestionHint" style="margin-bottom:8px;"></div>
              <div class="words" id="wordList"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <aside class="card">
    <div class="card-h">
      <div class="title">ğŸ’ èª²ç¨‹é¸æ“‡ï¼ˆæŒ‰éˆ•ï¼‰</div>
      <span class="badge">å³å´åªä¿ç•™è‡ªè¨‚è¼¸å…¥</span>
    </div>

    <div class="card-b">
      <div class="small">
        ä½ å¯ä»¥å…ˆç”¨å…§å»ºèª²ç¨‹ï¼›ä¹Ÿå¯ä»¥åœ¨ä¸‹æ–¹<strong>åªè¼¸å…¥èªè©</strong>å»ºç«‹ã€Œè‡ªè¨‚èª²ç¨‹ã€ï¼Œä¸¦æ°¸ä¹…å„²å­˜åœ¨æœ¬æ©Ÿç€è¦½å™¨ã€‚
      </div>

      <div class="divider"></div>

      <div class="row" style="justify-content:space-between;">
        <strong>èª²ç¨‹æ¸…å–®ï¼ˆé»æŒ‰éˆ•åˆ‡æ›ï¼‰</strong>
        <button class="btn-ghost" id="btnUseBuiltin">ä½¿ç”¨å…§å»ºé¡Œåº«</button>
      </div>
      <div class="lesson-grid" id="lessonGrid" style="margin-top:10px;"></div>

      <div class="divider"></div>

      <strong>è‡ªè¨‚å€ï¼ˆé¡Œç›® + å­—æ ¼å¯è‡ªè¨‚ï¼‰</strong>
      <div class="small" style="margin:6px 0 8px;">
        1) èª²ç¨‹åç¨±å¯æ”¹ï¼›2) èªè©<strong>æ¯è¡Œä¸€å€‹</strong>ï¼›3) å¯è¨­å®šã€Œé¡Œç›®æç¤ºã€ï¼›4) å¯é¸å­—æ ¼å¤§å°ï¼›5) å¯è²¼ä¸Šè‡ªè¨‚å­—æ ¼ï¼ˆè²¼äº†å°±ç›´æ¥ç”¨ï¼Œä¸å†è‡ªå‹•ç”Ÿæˆï¼‰ã€‚
      </div>

      <label class="small" for="customLessonName">è‡ªè¨‚èª²ç¨‹åç¨±ï¼ˆåŒåæœƒè¦†å¯«ï¼‰</label>
      <input id="customLessonName" type="text" value="è‡ªè¨‚èª²ç¨‹" />

      <div style="height:10px;"></div>

      <label class="small" for="customQuestion">é¡Œç›®æç¤ºæ–‡å­—ï¼ˆé¡¯ç¤ºåœ¨å·¦å´é¡Œç›®æç¤ºå€ï¼‰</label>
      <input id="customQuestion" type="text" value="è«‹æ‰¾å‡ºä¸‹åˆ—èªè©" />

      <div style="height:10px;"></div>

      <label class="small" for="customGridSize">å­—æ ¼å¤§å°</label>
      <select id="customGridSize">
        <option value="auto">è‡ªå‹•ï¼ˆä¾èªè©æ¨ä¼°ï¼‰</option>
        <option value="9">9 Ã— 9</option>
        <option value="10">10 Ã— 10</option>
        <option value="11">11 Ã— 11</option>
        <option value="12">12 Ã— 12</option>
        <option value="13">13 Ã— 13</option>
        <option value="14">14 Ã— 14</option>
      </select>

      <div style="height:10px;"></div>

      <label class="small" for="customWords">èªè©ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰</label>
      <textarea id="customWords" spellcheck="false" placeholder="ä¾‹å¦‚ï¼š
å·¨äºº
æ„‰æ‚…
æ‹œè¨ª
æç„¶å¤§æ‚Ÿ"></textarea>

      <div class="divider"></div>

      <strong>è‡ªè¨‚å­—æ ¼å…§å®¹ï¼ˆå¯é¸ï¼‰</strong>
      <div class="small" style="margin:6px 0 8px;">
        åªåœ¨ä½ æƒ³ã€ŒæŒ‡å®šå­—æ ¼é•·ç›¸ã€æ™‚ä½¿ç”¨ã€‚è«‹è²¼ä¸Š <strong>N è¡Œ</strong>ã€æ¯è¡Œ <strong>N å€‹å­—</strong>ï¼ˆä¸è¦ç©ºæ ¼ï¼‰ã€‚N éœ€èˆ‡ä¸Šé¢çš„å­—æ ¼å¤§å°ä¸€è‡´ï¼›è‹¥ä¸Šé¢é¸è‡ªå‹•ï¼Œæœƒä»¥ä½ è²¼ä¸Šçš„è¡Œåˆ—æ•¸ç‚ºæº–ã€‚
      </div>

      <textarea id="customGridText" spellcheck="false" placeholder="ç¯„ä¾‹ï¼ˆ5Ã—5ï¼‰ï¼š
å‚³çµ±é¤…åº—å•†
è¡Œé˜¿å©†éµè›‹
è’¼è€ç´…æ¯›åŸ
å±±å¡å›æ†¶å¤•
é™½æ–ç›ªç¶²é­š"></textarea>

      <div class="row" style="margin-top:10px;">
        <button class="btn-ghost" id="btnMakeGridTemplate" title="ä¾å­—æ ¼å¤§å°ç”¢ç”Ÿç©ºç™½æ¨¡æ¿ï¼ˆæ–¹ä¾¿è²¼ä¸Šï¼‰">ç”¢ç”Ÿç©ºç™½å­—æ ¼æ¨¡æ¿</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn-primary" id="btnApplyCustom">å»ºç«‹/æ›´æ–°è‡ªè¨‚èª²ç¨‹ï¼ˆä¸¦å„²å­˜ï¼‰</button>
        <button class="btn-ghost" id="btnClearCustom">æ¸…ç©º</button>
      </div>
      <div class="small" id="customNote" style="margin-top:10px;"></div>

      <div class="divider"></div>

      <strong>å·²å„²å­˜çš„è‡ªè¨‚èª²ç¨‹ï¼ˆæœ¬æ©Ÿï¼‰</strong>
      <div class="small" style="margin:6px 0 8px;">
        é€™äº›èª²ç¨‹æœƒä¿å­˜åœ¨åŒä¸€å°é›»è…¦/åŒä¸€å€‹ç€è¦½å™¨ä¸­ï¼›æ›é›»è…¦æˆ–æ¸…é™¤ç€è¦½å™¨è³‡æ–™å¾Œæœƒæ¶ˆå¤±ã€‚
      </div>

      <label class="small" for="savedSelect">é¸æ“‡è¦è¼‰å…¥çš„è‡ªè¨‚èª²ç¨‹</label>
      <select id="savedSelect"></select>

      <div class="row" style="margin-top:10px;">
        <button class="btn-ghost" id="btnLoadSaved">è¼‰å…¥åˆ°è¼¸å…¥æ¡†</button>
        <button class="btn-primary" id="btnPlaySaved">ç›´æ¥é–‹å§‹æ­¤èª²</button>
        <button class="btn-danger" id="btnDeleteSaved">åˆªé™¤æ­¤èª²ï¼ˆæœ¬æ©Ÿï¼‰</button>
      </div>

      <div class="divider"></div>

      <strong>éŠæˆ²è¦å‰‡ï¼ˆçµ¦å­¸ç”Ÿï¼‰</strong>
      <ul class="small" style="margin-top:8px; padding-left:18px;">
        <li>é»å³å´èª²ç¨‹æŒ‰éˆ•ï¼Œçœ‹åˆ°ã€Œæœ¬èª²èªè©æ¸…å–®ã€ã€‚</li>
        <li>åœ¨å­—æ ¼ä¸­æŒ‰ä½æ‹–æ›³é€£ç·šï¼šåªå…è¨± <strong>â†“ã€â†˜ã€â†™</strong>ã€‚</li>
        <li>æ‰¾åˆ°æœƒæ‰“å‹¾ï¼›å…¨éƒ¨æ‰¾å®Œæœƒæ’­æ”¾ä¸åŒå®ŒæˆéŸ³æ•ˆä¸¦åœæ­¢è¨ˆæ™‚ã€‚</li>
        <li>æŒ‰ã€Œæš«åœã€æœƒé–ä½å­—æ ¼ï¼ˆç„¡æ³•æ“ä½œï¼‰ã€‚</li>
      </ul>
    </div>
  </aside>
</main>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
const BUILTIN = {
  lessons: [
    { lesson: "G3Aç¬¬ä¸ƒèª²æ·¡æ°´å°é®", words: ["å‚³çµ±","é¤…åº—","å•†è¡Œ","é˜¿å©†","éµè›‹","è’¼è€","ç´…æ¯›åŸ","å±±å¡","å›æ†¶","å¤•é™½","æ–ç›ª","ç¶²é­š","å …ç¡¬"], question:"è«‹æ‰¾å‡ºä¸‹åˆ—èªè©" },
    { lesson: "G3Aç¬¬å…«èª²å®‰å¹³å¤å ¡åƒè§€è¨˜ï¼ˆç²¾ç°¡15è©ï¼‰", words: ["æ•™è‚²","åšç‰©é¤¨","å²æ–™","æ¨¡å‹","è·è˜­","é„­æˆåŠŸ","æ‰“æ•—","é§å®ˆ","å®ˆè­·","å‹‡æ•¢","å£«å…µ","åœŸåœ°","ç­æœ›è‡º","å±‹é ‚","åœ°æ¨™"], question:"è«‹æ‰¾å‡ºä¸‹åˆ—èªè©" },
    { lesson: "G3Aç¬¬ä¹èª²é¦¬å¤ªéçš„å·´æ‹‰å‘Š", words: ["èŠ±è“®","é¦¬å¤ªé","å·´æ‹‰å‘Š","æº¼åœ°","é˜¿ç¾æ—","ç‰¹åˆ¥","æ•é­š","æ–¹å¼","æ‰“é€ ","é­šå±‹","ç«¹å­","æ¤ç‰©","é‡£é­š","æ™ºæ…§","ç”Ÿæ…‹"], question:"è«‹æ‰¾å‡ºä¸‹åˆ—èªè©" },
    { lesson: "G3Aç¬¬åèª²ç‹ç‹¸çš„ç¥•å¯†", words: ["ç‹ç‹¸","è¬é‡Œ","å…„å¼Ÿ","ç¥•å¯†","æ”¾æ£„","çƒé´‰","å¦™è¨ˆ","å¼·å£¯","é…¸è‘¡è„","é€²å…¥","é£›è¸¢","è‚‰å¡Š"], question:"è«‹æ‰¾å‡ºä¸‹åˆ—èªè©" },
    { lesson: "G3Aç¬¬åä¸€èª²å·¨äººçš„èŠ±åœ’", words: ["å·¨äºº","æ„‰æ‚…","æ‹œè¨ª","å…å¾—","é›¢é–‹","é¡¯å¾—","æ¼«é•·","ä¹¾æ¯","æç„¶å¤§æ‚Ÿ","æ‹†é™¤","åœç‰†","ç››é–‹"], question:"è«‹æ‰¾å‡ºä¸‹åˆ—èªè©" },
    { lesson: "G3Aç¬¬åäºŒèª²å¥‡ç‰¹çš„æœ‹å‹", words: ["æ•…éšœ","ç¶¿ç¾Š","æ²™æ¼ ","ä¸­å¤®","ç”·å­©","é‡è¤‡","ç–‘å•","æ‰“ç®—","å¸½å­","å¾Œé€€","èŸ’è›‡","é©šè¨"], question:"è«‹æ‰¾å‡ºä¸‹åˆ—èªè©" }
  ]
};

/**
 * è‡ªè¨‚èª²ç¨‹å„²å­˜ schemaï¼ˆv2ï¼‰ï¼š
 * { lesson, words[], question?, gridSizeMode:'auto'|number, gridText? }
 */
const LS_KEY = "cute_wordsearch_custom_lessons_v2";

function loadSavedCustomLessons(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return [];
    return arr
      .map(x => ({
        lesson: String(x.lesson || "").trim(),
        words: Array.isArray(x.words) ? x.words.map(w=>String(w||"").trim()).filter(Boolean) : [],
        question: String(x.question || "è«‹æ‰¾å‡ºä¸‹åˆ—èªè©").trim() || "è«‹æ‰¾å‡ºä¸‹åˆ—èªè©",
        gridSizeMode: (x.gridSizeMode === "auto" || Number.isFinite(Number(x.gridSizeMode))) ? x.gridSizeMode : "auto",
        gridText: String(x.gridText || "").replace(/\r/g,"").trim()
      }))
      .filter(x => x.lesson && x.words.length >= 2);
  }catch(_){
    return [];
  }
}
function saveCustomLessons(list){
  try{
    localStorage.setItem(LS_KEY, JSON.stringify(list));
    return true;
  }catch(_){
    return false;
  }
}
function normalizeWords(words){
  const seen = new Set();
  const out = [];
  for(const w of words){
    const t = String(w||"").trim();
    if(!t) continue;
    if(seen.has(t)) continue;
    seen.add(t);
    out.push(t);
  }
  return out;
}
function parseLinesToWords(raw){
  const lines = String(raw||"")
    .replace(/\r/g,"")
    .split("\n")
    .map(s => s.trim())
    .filter(s => s.length > 0);
  return normalizeWords(lines);
}
function upsertSavedLesson(payload){
  const cleanName = String(payload.lesson||"").trim();
  const cleanWords = normalizeWords(payload.words || []);
  const question = String(payload.question || "è«‹æ‰¾å‡ºä¸‹åˆ—èªè©").trim() || "è«‹æ‰¾å‡ºä¸‹åˆ—èªè©";
  const gridSizeMode = payload.gridSizeMode ?? "auto";
  const gridText = String(payload.gridText || "").replace(/\r/g,"").trim();

  if(!cleanName) throw new Error("èª²ç¨‹åç¨±ä¸å¯ç©ºç™½ã€‚");
  if(cleanWords.length < 2) throw new Error("è‡³å°‘éœ€è¦ 2 å€‹èªè©ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰ã€‚");

  const list = loadSavedCustomLessons();
  const idx = list.findIndex(x => x.lesson === cleanName);

  const saved = { lesson: cleanName, words: cleanWords, question, gridSizeMode, gridText };
  if(idx >= 0) list[idx] = saved;
  else list.unshift(saved);

  if(!saveCustomLessons(list)) throw new Error("å„²å­˜å¤±æ•—ï¼šå¯èƒ½æ˜¯ç€è¦½å™¨é˜»æ“‹æˆ–å„²å­˜ç©ºé–“ä¸è¶³ã€‚");
  return list;
}
function deleteSavedLessonByName(lessonName){
  const name = String(lessonName||"").trim();
  const list = loadSavedCustomLessons().filter(x => x.lesson !== name);
  if(!saveCustomLessons(list)) throw new Error("åˆªé™¤å¤±æ•—ï¼šå¯èƒ½æ˜¯ç€è¦½å™¨é˜»æ“‹æˆ–å„²å­˜ç©ºé–“ä¸è¶³ã€‚");
  return list;
}

let DB = structuredClone(BUILTIN);
let currentLessonIndex = 0;
let gridSize = 10;
let grid = [];
let placements = new Map();
let found = new Set();
let selecting = false;
let startCell = null;
let currentPath = [];
let pointerId = null;

const elLessonGrid = document.getElementById("lessonGrid");
const elGrid = document.getElementById("grid");
const elPauseOverlay = document.getElementById("pauseOverlay");
const elWordList = document.getElementById("wordList");
const elFoundCount = document.getElementById("foundCount");
const elTotalCount = document.getElementById("totalCount");
const elBadgeSize = document.getElementById("badgeSize");
const elPillLesson = document.getElementById("pillLesson");
const elLessonMeta = document.getElementById("lessonMeta");
const elToast = document.getElementById("toast");
const elPillProgress = document.getElementById("pillProgress");
const elTTSToggle = document.getElementById("ttsToggle");
const elQuestionText = document.getElementById("questionText");
const elLessonQuestionHint = document.getElementById("lessonQuestionHint");

const elCustomLessonName = document.getElementById("customLessonName");
const elCustomQuestion = document.getElementById("customQuestion");
const elCustomGridSize = document.getElementById("customGridSize");
const elCustomWords = document.getElementById("customWords");
const elCustomGridText = document.getElementById("customGridText");
const elCustomNote = document.getElementById("customNote");

const elSavedSelect = document.getElementById("savedSelect");
const btnLoadSaved = document.getElementById("btnLoadSaved");
const btnPlaySaved = document.getElementById("btnPlaySaved");
const btnDeleteSaved = document.getElementById("btnDeleteSaved");

const elTimerText = document.getElementById("timerText");
const btnTimerToggle = document.getElementById("btnTimerToggle");
const btnTimerReset = document.getElementById("btnTimerReset");

let timerMs = 0;
let timerRunning = false;
let timerHandle = null;
let timerLastTs = null;

function fmtTime(ms){
  const totalSec = Math.floor(ms / 1000);
  const m = Math.floor(totalSec / 60);
  const s = totalSec % 60;
  return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
}
function renderTimer(){ elTimerText.textContent = fmtTime(timerMs); }
function setPausedUI(paused){
  if(paused){
    elGrid.classList.add("paused");
    elPauseOverlay.classList.add("show");
    elPauseOverlay.setAttribute("aria-hidden","false");
  }else{
    elGrid.classList.remove("paused");
    elPauseOverlay.classList.remove("show");
    elPauseOverlay.setAttribute("aria-hidden","true");
  }
}
function startTimer(){
  if(timerRunning) return;
  timerRunning = true;
  btnTimerToggle.textContent = "æš«åœ";
  setPausedUI(false);
  timerLastTs = performance.now();
  timerHandle = setInterval(()=>{
    const now = performance.now();
    timerMs += Math.max(0, now - timerLastTs);
    timerLastTs = now;
    renderTimer();
  }, 200);
}
function pauseTimer(){
  if(!timerRunning){ startTimer(); return; }
  timerRunning = false;
  btnTimerToggle.textContent = "ç¹¼çºŒ";
  clearInterval(timerHandle);
  timerHandle = null;
  timerLastTs = null;
  setPausedUI(true);
  clearSelection();
  selecting = false;
  pointerId = null;
  startCell = null;
}
function resetTimer(autoStart=true){
  timerMs = 0;
  renderTimer();
  if(autoStart){
    timerRunning = false;
    clearInterval(timerHandle);
    timerHandle = null;
    startTimer();
  }else{
    timerRunning = false;
    clearInterval(timerHandle);
    timerHandle = null;
    btnTimerToggle.textContent = "ç¹¼çºŒ";
    setPausedUI(true);
  }
}
btnTimerToggle.addEventListener("click", ()=>{ if(timerRunning) pauseTimer(); else startTimer(); });
btnTimerReset.addEventListener("click", ()=>{
  resetTimer(true);
  showToast("è¨ˆæ™‚å·²é‡è¨­", "å·²æ­¸é›¶ä¸¦é‡æ–°é–‹å§‹è¨ˆæ™‚ã€‚", 1200);
});

function showToast(title, msg, ms=1600){
  elToast.innerHTML = `<strong>${escapeHtml(title)}</strong><div class="small">${escapeHtml(msg)}</div>`;
  elToast.classList.add("show");
  window.clearTimeout(showToast._t);
  showToast._t = window.setTimeout(()=> elToast.classList.remove("show"), ms);
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function computeGridSize(words){
  const maxLen = Math.max(...words.map(w=>w.length), 2);
  const count = words.length;
  let n = 10;
  if(count >= 13) n = 11;
  if(maxLen >= 5) n = Math.max(n, 12);
  if(maxLen >= 7) n = Math.max(n, 13);
  return Math.min(Math.max(n, 9), 14);
}
function setResponsiveCellSize(n){
  const maxGridPx = Math.min(520, Math.max(320, window.innerWidth - 60));
  const cell = Math.floor((maxGridPx - 20) / n);
  document.documentElement.style.setProperty("--cell", `${Math.max(28, Math.min(52, cell))}px`);
  document.documentElement.style.setProperty("--n", n);
}

const DIRECTIONS = [
  { dr: 1, dc: 0 },
  { dr: 1, dc: 1 },
  { dr: 1, dc: -1 }
];

function canPlace(word, r, c, dir, n, board){
  const L = word.length;
  const endR = r + dir.dr*(L-1);
  const endC = c + dir.dc*(L-1);
  if(endR < 0 || endR >= n || endC < 0 || endC >= n) return false;
  for(let i=0;i<L;i++){
    const rr = r + dir.dr*i;
    const cc = c + dir.dc*i;
    const ch = board[rr][cc];
    if(ch !== "" && ch !== word[i]) return false;
  }
  return true;
}
function placeWord(word, n, board){
  const tries = 520;
  for(let t=0;t<tries;t++){
    const dir = choice(DIRECTIONS);
    const r = randInt(0, n-1);
    const c = randInt(0, n-1);
    if(!canPlace(word, r, c, dir, n, board)) continue;
    const coords = [];
    for(let i=0;i<word.length;i++){
      const rr = r + dir.dr*i;
      const cc = c + dir.dc*i;
      board[rr][cc] = word[i];
      coords.push({r:rr, c:cc});
    }
    return coords;
  }
  return null;
}
function fillRandomChars(n, board){
  const pool = "çš„ä¸€æ˜¯åœ¨ä¸äº†æœ‰å’Œäººé€™ä¸­å¤§ç‚ºä¸Šå€‹åœ‹æˆ‘ä»¥è¦ä»–æ™‚ä¾†ç”¨å€‘ç”Ÿåˆ°ä½œåœ°æ–¼å‡ºå°±åˆ†å°æˆæœƒå¯ä¸»ç™¼å¹´å‹•åŒå·¥ä¹Ÿèƒ½ä¸‹éå­èªªç”¢ç¨®é¢è€Œæ–¹å¾Œå¤šå®šè¡Œå­¸æ³•æ‰€æ°‘å¾—ç¶“åä¸‰ä¹‹é€²è‘—ç­‰éƒ¨åº¦å®¶é›»åŠ›è£¡å¦‚æ°´åŒ–é«˜è‡ªäºŒç†èµ·å°ç‰©ç¾å¯¦åŠ é‡éƒ½å…©é«”åˆ¶æ©Ÿç•¶ä½¿é»å¾æ¥­æœ¬å»æŠŠæ€§å¥½æ‡‰é–‹å®ƒåˆé‚„å› ç”±å…¶äº›ç„¶å‰å¤–å¤©æ”¿å››æ—¥é‚£ç¤¾ç¾©äº‹å¹³å½¢ç›¸å…¨è¡¨é–“æ¨£èˆ‡é—œå„æ–°ç·šå…§æ•¸æ­£å¿ƒåä½ æ˜çœ‹åŸåˆéº¼åˆ©æ¯”æˆ–ä½†è³ªæ°£ç¬¬å‘é“å‘½æ­¤è®Šæ¢åªæ²’çµè§£å•æ„å»ºæœˆå…¬ç„¡ç³»è»å¾ˆæƒ…è€…æœ€ç«‹ä»£æƒ³å·²é€šä¸¦æç›´é¡Œé»¨ç¨‹å±•äº”æœæ–™è±¡å“¡é©ä½å…¥å¸¸æ–‡ç¸½æ¬¡å“å¼æ´»è¨­åŠç®¡ç‰¹ä»¶é•·æ±‚è€é ­åŸºè³‡é‚Šæµè·¯ç´šå°‘åœ–å±±æµ·æ ¡æ›¸æ¡Œç­†èª²".split("");
  for(let r=0;r<n;r++){
    for(let c=0;c<n;c++){
      if(board[r][c] === "") board[r][c] = choice(pool);
    }
  }
}

/** è§£æè€å¸«è‡ªè¨‚å­—æ ¼ï¼šNè¡Œï¼Œæ¯è¡ŒNå­—ï¼Œä¸å«ç©ºæ ¼ */
function parseCustomGridText(text){
  const raw = String(text||"").replace(/\r/g,"").trim();
  if(!raw) return null;
  const lines = raw.split("\n").map(s => s.trim()).filter(Boolean);
  if(lines.length < 2) throw new Error("è‡ªè¨‚å­—æ ¼è‡³å°‘éœ€è¦ 2 è¡Œã€‚");
  const n = lines.length;
  const rows = lines.map(line => line.replace(/\s+/g,""));
  for(const r of rows){
    if(r.length !== n) throw new Error(`è‡ªè¨‚å­—æ ¼æ ¼å¼éŒ¯èª¤ï¼šéœ€è¦ ${n}Ã—${n}ï¼Œä½†æŸä¸€è¡Œé•·åº¦æ˜¯ ${r.length}ã€‚`);
  }
  const board = rows.map(r => r.split(""));
  return { n, board };
}

/** åœ¨è‡ªè¨‚å­—æ ¼ä¸­æ‰¾å‡ºæ¯å€‹èªè©çš„åº§æ¨™ï¼ˆåƒ…â†“â†˜â†™ï¼‰ï¼Œç”¨æ–¼æ‰¾åˆ°å¾Œä¸Šè‰²ï¼ˆæ‰¾ä¸åˆ°ä¹Ÿä¸æ“‹éŠæˆ²ï¼‰ã€‚ */
function scanPlacementsFromBoard(words, n, board){
  const map = new Map();
  const inRange = (r,c)=> r>=0 && r<n && c>=0 && c<n;
  for(const w of words){
    let foundCoords = null;
    outer:
    for(let r=0;r<n;r++){
      for(let c=0;c<n;c++){
        for(const dir of DIRECTIONS){
          let ok = true;
          const coords = [];
          for(let i=0;i<w.length;i++){
            const rr = r + dir.dr*i;
            const cc = c + dir.dc*i;
            if(!inRange(rr,cc)){ ok=false; break; }
            if(board[rr][cc] !== w[i]){ ok=false; break; }
            coords.push({r:rr,c:cc});
          }
          if(ok){
            foundCoords = coords;
            break outer;
          }
        }
      }
    }
    if(foundCoords) map.set(w, foundCoords);
    else map.set(w, null);
  }
  return map;
}

/** æ±ºå®šå­—æ ¼å¤§å°ï¼šå„ªå…ˆè‡ªè¨‚å­—æ ¼ï¼Œå…¶æ¬¡èª²ç¨‹å›ºå®šå¤§å°ï¼Œå…¶æ¬¡è‡ªå‹• */
function resolveGridSize(lesson, words, customGridParsed){
  if(customGridParsed?.n) return customGridParsed.n;
  const mode = lesson.gridSizeMode;
  if(mode === "auto" || mode == null) return computeGridSize(words);
  const n = Number(mode);
  if(Number.isFinite(n)) return Math.min(Math.max(n,9),14);
  return computeGridSize(words);
}

function buildPuzzle(lesson){
  const words = normalizeWords(lesson.words);
  if(words.length < 1) throw new Error("æœ¬èª²æ²’æœ‰èªè©ã€‚");

  // 1) è‹¥æœ‰è‡ªè¨‚å­—æ ¼ï¼šç›´æ¥ä½¿ç”¨è€å¸«å­—æ ¼
  let customGridParsed = null;
  try{
    customGridParsed = parseCustomGridText(lesson.gridText || "");
  }catch(err){
    // è‡ªè¨‚å­—æ ¼æœ‰å¡«ä½†æ ¼å¼éŒ¯ï¼šç›´æ¥æ“‹ä¸‹ï¼ˆé¿å…å­¸ç”Ÿçœ‹åˆ°å£å­—æ ¼ï¼‰
    throw err;
  }
  const n = resolveGridSize(lesson, words, customGridParsed);
  gridSize = n;
  setResponsiveCellSize(gridSize);

  if(customGridParsed){
    grid = customGridParsed.board;
    placements = scanPlacementsFromBoard(words, gridSize, grid);
    // æç¤ºï¼šè‹¥æŸäº›è©æ‰¾ä¸åˆ°ï¼Œä¸é˜»æ“‹ï¼Œä½†æé†’è€å¸«
    const missing = words.filter(w => !placements.get(w));
    if(missing.length){
      showToast("æé†’ï¼šè‡ªè¨‚å­—æ ¼ä¸­æœ‰è©æ‰¾ä¸åˆ°", `ä»¥ä¸‹èªè©æœªæƒæåˆ°ï¼ˆä»å¯éŠæˆ²ï¼Œä½†æ‰¾åˆ°å¾Œå¯èƒ½ç„¡æ³•ä¸Šè‰²ï¼‰ï¼š${missing.slice(0,6).join("ã€")}${missing.length>6?"â€¦":""}`, 2600);
    }
    return { words };
  }

  // 2) å¦å‰‡ï¼šä¾æ–¹å‘è¦å‰‡è‡ªå‹•æ”¾ç½®èªè©
  grid = Array.from({length:gridSize}, ()=> Array.from({length:gridSize}, ()=> ""));
  placements = new Map();
  const sorted = [...words].sort((a,b)=> b.length - a.length);

  for(const w of sorted){
    const coords = placeWord(w, gridSize, grid);
    if(!coords){
      // è‹¥ä½¿ç”¨è€…æŒ‡å®šå›ºå®šå¤§å°ä¸”æ”¾ä¸ä¸‹ï¼Œç›´æ¥å ±éŒ¯ï¼ˆä¸é»˜é»˜æ”¹å¤§ï¼Œé¿å…é•èƒŒè€å¸«è¨­å®šï¼‰
      const fixed = (lesson.gridSizeMode && lesson.gridSizeMode !== "auto");
      if(fixed){
        throw new Error(`èªè©æ”¾ç½®å¤±æ•—ï¼š${w}ï¼ˆæ­¤èª²å­—æ ¼å¤§å°å›ºå®šç‚º ${gridSize}Ã—${gridSize}ï¼Œå¯æ”¹å¤§æˆ–ç¸®çŸ­/æ¸›å°‘èªè©ï¼‰`);
      }
      // è‡ªå‹•æ¨¡å¼ï¼šå…è¨±é€æ­¥æ”¾å¤§åˆ°14
      if(gridSize < 14){
        gridSize += 1;
        setResponsiveCellSize(gridSize);
        grid = Array.from({length:gridSize}, ()=> Array.from({length:gridSize}, ()=> ""));
        placements = new Map();
        for(const ww of sorted){
          const cc = placeWord(ww, gridSize, grid);
          if(!cc) throw new Error(`èªè©æ”¾ç½®å¤±æ•—ï¼š${ww}ï¼ˆå¯æ¸›å°‘èªè©æ•¸æˆ–ç¸®çŸ­è©é•·ï¼‰`);
          placements.set(ww, cc);
        }
        fillRandomChars(gridSize, grid);
        return { words };
      } else {
        throw new Error(`èªè©æ”¾ç½®å¤±æ•—ï¼š${w}ï¼ˆå¯æ¸›å°‘èªè©æ•¸æˆ–ç¸®çŸ­è©é•·ï¼‰`);
      }
    }
    placements.set(w, coords);
  }
  fillRandomChars(gridSize, grid);
  return { words };
}

function playTone(ctx, freq, ms, gain=0.05, type="sine"){
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = type;
  o.frequency.value = freq;
  g.gain.value = gain;
  o.connect(g); g.connect(ctx.destination);
  o.start();
  setTimeout(()=>{ o.stop(); }, ms);
}
function sfxFoundOne(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    playTone(ctx, 880, 90, 0.05);
    setTimeout(()=> playTone(ctx, 1175, 120, 0.05), 110);
    setTimeout(()=> ctx.close(), 320);
  }catch(_){}
}
function sfxAllDone(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    playTone(ctx, 659, 110, 0.05);
    setTimeout(()=> playTone(ctx, 784, 110, 0.05), 120);
    setTimeout(()=> playTone(ctx, 988, 140, 0.05), 240);
    setTimeout(()=> playTone(ctx, 1319, 180, 0.05), 400);
    setTimeout(()=> ctx.close(), 700);
  }catch(_){}
}
function sfxWrong(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    playTone(ctx, 220, 160, 0.05);
    setTimeout(()=> ctx.close(), 220);
  }catch(_){}
}
function speak(text){
  try{
    if(!("speechSynthesis" in window)) return;
    const u = new SpeechSynthesisUtterance(text);
    const voices = window.speechSynthesis.getVoices?.() || [];
    const zh = voices.find(v => /zh|Chinese/i.test(v.lang) || /zh|Chinese/i.test(v.name));
    if(zh) u.voice = zh;
    u.lang = "zh-TW";
    u.rate = 0.95;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }catch(_){}
}

function renderLessons(){
  elLessonGrid.innerHTML = "";
  DB.lessons.forEach((l, idx)=>{
    const btn = document.createElement("button");
    btn.className = "lesson-btn";
    if(idx === currentLessonIndex) btn.classList.add("active");
    const words = normalizeWords(l.words || []);
    const prefix = l._saved ? "ğŸ“ " : "ğŸŒŸ ";
    const q = String(l.question || "è«‹æ‰¾å‡ºä¸‹åˆ—èªè©").trim();
    const gridTag = (String(l.gridText||"").trim()) ? "ï¼ˆè‡ªè¨‚å­—æ ¼ï¼‰" : "";
    btn.innerHTML = `<strong>${prefix}${escapeHtml(l.lesson)}${escapeHtml(gridTag)}</strong><span>${words.length} å€‹èªè©ï½œ${escapeHtml(q)}</span>`;
    btn.addEventListener("click", ()=>{
      currentLessonIndex = idx;
      startLesson(true);
      renderLessons();
    });
    elLessonGrid.appendChild(btn);
  });
}
function renderWordList(words){
  elWordList.innerHTML = "";
  elTotalCount.textContent = String(words.length);
  for(const w of words){
    const item = document.createElement("div");
    item.className = "w";
    item.dataset.word = w;
    item.innerHTML = `<span>${escapeHtml(w)}</span><span class="tick">â–¡</span>`;
    item.addEventListener("click", ()=>{ if(elTTSToggle.checked) speak(w); });
    elWordList.appendChild(item);
  }
  updateProgress();
}
function renderGrid(){
  elGrid.innerHTML = "";
  elGrid.style.setProperty("--n", gridSize);
  for(let r=0;r<gridSize;r++){
    for(let c=0;c<gridSize;c++){
      const d = document.createElement("div");
      d.className = "cell";
      d.textContent = grid[r][c];
      d.dataset.r = r;
      d.dataset.c = c;
      elGrid.appendChild(d);
    }
  }
}
function setHeaderMeta(words){
  const lesson = DB.lessons[currentLessonIndex];
  elPillLesson.textContent = `ç›®å‰ï¼š${lesson.lesson}`;
  elLessonMeta.textContent = `å…± ${words.length} è©ï½œå­—æ ¼ ${gridSize}Ã—${gridSize}`;
  elBadgeSize.textContent = `${gridSize}Ã—${gridSize}`;
  const q = String(lesson.question || "è«‹æ‰¾å‡ºä¸‹åˆ—èªè©").trim() || "è«‹æ‰¾å‡ºä¸‹åˆ—èªè©";
  elQuestionText.textContent = q;
  elLessonQuestionHint.textContent = `é¡Œç›®ï¼š${q}`;
}
function updateProgress(){
  elFoundCount.textContent = String(found.size);
  const total = Number(elTotalCount.textContent || "0");
  elPillProgress.style.display = (total > 0 && found.size === total) ? "inline-flex" : "none";
}
function getCellEl(r,c){ return elGrid.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`); }
function clearSelection(){
  for(const el of elGrid.querySelectorAll(".cell.sel")) el.classList.remove("sel");
  currentPath = [];
}
function applySelection(path){
  clearSelection();
  for(const p of path){
    const cell = getCellEl(p.r, p.c);
    if(cell) cell.classList.add("sel");
  }
  currentPath = path;
}

function getLinePath(a, b){
  const dr = b.r - a.r;
  const dc = b.c - a.c;
  const adr = Math.abs(dr), adc = Math.abs(dc);

  if(dr === 0 && dc === 0) return [{r:a.r,c:a.c}];

  if(dc === 0 && dr > 0){
    const path = [];
    for(let i=0;i<=dr;i++) path.push({r:a.r + i, c:a.c});
    return path;
  }
  if(dr > 0 && dc > 0 && adr === adc){
    const path = [];
    for(let i=0;i<=adr;i++) path.push({r:a.r + i, c:a.c + i});
    return path;
  }
  if(dr > 0 && dc < 0 && adr === adc){
    const path = [];
    for(let i=0;i<=adr;i++) path.push({r:a.r + i, c:a.c - i});
    return path;
  }
  return null;
}
function pathToString(path){ return path.map(p => grid[p.r][p.c]).join(""); }

function markFound(word){
  found.add(word);
  const coords = placements.get(word);
  if(coords){
    for(const p of coords){
      const el = getCellEl(p.r, p.c);
      if(el) el.classList.add("found");
    }
  }
  const item = elWordList.querySelector(`.w[data-word="${CSS.escape(word)}"]`);
  if(item){
    item.classList.add("found");
    const tick = item.querySelector(".tick");
    if(tick) tick.textContent = "âœ“";
  }
  updateProgress();
}

function cellFromPoint(x,y){
  const el = document.elementFromPoint(x,y);
  if(!el) return null;
  const cell = el.closest?.(".cell");
  if(!cell) return null;
  return { r: Number(cell.dataset.r), c: Number(cell.dataset.c) };
}
function onPointerDown(e){
  if(!timerRunning) return;
  elGrid.setPointerCapture?.(e.pointerId);
  pointerId = e.pointerId;
  const p = cellFromPoint(e.clientX, e.clientY);
  if(!p) return;
  selecting = true;
  startCell = p;
  applySelection([p]);
}
function onPointerMove(e){
  if(!selecting || e.pointerId !== pointerId) return;
  const p = cellFromPoint(e.clientX, e.clientY);
  if(!p || !startCell) return;
  const path = getLinePath(startCell, p);
  if(!path) return;
  applySelection(path);
}
function onPointerUp(e){
  if(!selecting || e.pointerId !== pointerId) return;
  selecting = false;
  pointerId = null;

  const selected = pathToString(currentPath);
  const words = normalizeWords(DB.lessons[currentLessonIndex].words);
  const hit = words.find(w => w === selected) || null;

  if(hit && !found.has(hit)){
    markFound(hit);
    const total = Number(elTotalCount.textContent || "0");
    const doneAll = (total > 0 && found.size === total);

    if(doneAll){
      sfxAllDone();
      timerRunning = false;
      clearInterval(timerHandle);
      timerHandle = null;
      btnTimerToggle.textContent = "ç¹¼çºŒ";
      setPausedUI(true);
      showToast("å…¨éƒ½æ‰¾åˆ°äº†ï¼", `ä½ å®Œæˆäº†ã€Œ${DB.lessons[currentLessonIndex].lesson}ã€ã€‚ç”¨æ™‚ ${fmtTime(timerMs)}ã€‚`, 2600);
    }else{
      sfxFoundOne();
      showToast("æ‰¾åˆ°å•¦ï¼", `ä½ æ‰¾åˆ°äº†ã€Œ${hit}ã€ã€‚`);
    }
    if(elTTSToggle.checked) speak(hit);
  }else if(hit && found.has(hit)){
    sfxWrong();
    showToast("é€™å€‹å·²ç¶“æ‰¾éäº†", `ã€Œ${hit}ã€å·²ç¶“æ‰“å‹¾äº†ã€‚`, 1200);
  }else{
    sfxWrong();
  }

  for(const el of elGrid.querySelectorAll(".cell.sel")) el.classList.remove("sel");
  currentPath = [];
  startCell = null;
}

function upsertCustomIntoDB(lessonObj){
  const idx = DB.lessons.findIndex(l => l._custom === true);
  const payload = Object.assign({}, lessonObj, { _custom:true, _saved:true });
  if(idx >= 0){ DB.lessons[idx] = payload; return idx; }
  DB.lessons.unshift(payload); return 0;
}

function refreshSavedSelect(){
  const list = loadSavedCustomLessons();
  elSavedSelect.innerHTML = "";

  if(list.length === 0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "ï¼ˆç›®å‰æ²’æœ‰å·²å„²å­˜çš„è‡ªè¨‚èª²ç¨‹ï¼‰";
    elSavedSelect.appendChild(opt);
    elSavedSelect.disabled = true;
    btnLoadSaved.disabled = true;
    btnPlaySaved.disabled = true;
    btnDeleteSaved.disabled = true;
    return;
  }

  elSavedSelect.disabled = false;
  btnLoadSaved.disabled = false;
  btnPlaySaved.disabled = false;
  btnDeleteSaved.disabled = false;

  for(const item of list){
    const opt = document.createElement("option");
    opt.value = item.lesson;
    const tag = item.gridText ? "ï½œè‡ªè¨‚å­—æ ¼" : "";
    opt.textContent = `${item.lesson}ï¼ˆ${item.words.length}è©${tag}ï¼‰`;
    elSavedSelect.appendChild(opt);
  }
}
function getSavedSelected(){
  const name = elSavedSelect.value;
  if(!name) return null;
  return loadSavedCustomLessons().find(x => x.lesson === name) || null;
}
function mergeSavedIntoDB(){
  const saved = loadSavedCustomLessons().map(x => ({
    lesson: x.lesson,
    words: x.words,
    question: x.question,
    gridSizeMode: x.gridSizeMode,
    gridText: x.gridText,
    _saved: true
  }));
  const currentCustom = DB.lessons.find(l => l._custom === true) || null;
  const builtins = structuredClone(BUILTIN).lessons;
  const combined = [];
  combined.push(...saved);
  if(currentCustom) combined.push(currentCustom);
  combined.push(...builtins);
  DB.lessons = combined;
  currentLessonIndex = Math.min(currentLessonIndex, DB.lessons.length - 1);
}

function startLesson(regenerate=true){
  const lesson = DB.lessons[currentLessonIndex];
  resetTimer(true);

  if(regenerate){
    found.clear();
    placements = new Map();
    const result = buildPuzzle(lesson);
    setHeaderMeta(result.words);
    renderGrid();
    renderWordList(result.words);
    showToast("é–‹å§‹å›‰ï¼", `å·²è¼‰å…¥ã€Œ${lesson.lesson}ã€ã€‚`);
  }else{
    found.clear();
    for(const el of elGrid.querySelectorAll(".cell.found")) el.classList.remove("found");
    for(const el of elWordList.querySelectorAll(".w.found")){
      el.classList.remove("found");
      const tick = el.querySelector(".tick");
      if(tick) tick.textContent = "â–¡";
    }
    updateProgress();
    showToast("é‡æ–°é–‹å§‹", "å·²æ¸…é™¤æ‰¾åˆ°ç‹€æ…‹ä¸¦é‡æ–°è¨ˆæ™‚ã€‚");
  }
  renderLessons();
}

document.getElementById("btnApplyCustom").addEventListener("click", ()=>{
  try{
    const lesson = String(elCustomLessonName.value||"").trim();
    const question = String(elCustomQuestion.value||"").trim() || "è«‹æ‰¾å‡ºä¸‹åˆ—èªè©";
    const words = parseLinesToWords(elCustomWords.value);

    const gridSizeMode = elCustomGridSize.value; // auto | 9..14
    const gridText = String(elCustomGridText.value||"").replace(/\r/g,"").trim();

    // è‹¥å¡«äº†è‡ªè¨‚å­—æ ¼ï¼šå…ˆåšæ ¼å¼æª¢æŸ¥ï¼ˆé¿å…å­˜å…¥å£è³‡æ–™ï¼‰
    if(gridText){
      const parsed = parseCustomGridText(gridText);
      // è‹¥è€å¸«åŒæ™‚é¸äº†å›ºå®šå¤§å°ï¼Œéœ€ä¸€è‡´
      if(gridSizeMode !== "auto"){
        const want = Number(gridSizeMode);
        if(parsed.n !== want) throw new Error(`è‡ªè¨‚å­—æ ¼æ˜¯ ${parsed.n}Ã—${parsed.n}ï¼Œä½†ä½ é¸çš„æ˜¯ ${want}Ã—${want}ã€‚è«‹ä¸€è‡´å¾Œå†å„²å­˜ã€‚`);
      }
    }

    upsertSavedLesson({ lesson, words, question, gridSizeMode, gridText });
    upsertCustomIntoDB({ lesson, words, question, gridSizeMode, gridText });
    mergeSavedIntoDB();
    refreshSavedSelect();

    const savedIdx = DB.lessons.findIndex(l => l._saved && l.lesson === lesson);
    currentLessonIndex = savedIdx >= 0 ? savedIdx : 0;

    const gtag = gridText ? "ï¼ˆå«è‡ªè¨‚å­—æ ¼ï¼‰" : "";
    elCustomNote.textContent = `å·²å„²å­˜ã€Œ${lesson}ã€ï¼Œå…± ${words.length} å€‹èªè©${gtag}ã€‚`;
    showToast("è‡ªè¨‚å·²å„²å­˜", `å·²ä¿å­˜åˆ°æœ¬æ©Ÿï¼š${lesson}ã€‚`);
    startLesson(true);
  }catch(err){
    showToast("è‡ªè¨‚å¤±æ•—", err.message || String(err), 2600);
  }
});

document.getElementById("btnClearCustom").addEventListener("click", ()=>{
  elCustomWords.value = "";
  elCustomGridText.value = "";
  elCustomNote.textContent = "";
  showToast("å·²æ¸…ç©º", "å¯ä»¥é‡æ–°è²¼ä¸Šèªè©/å­—æ ¼ã€‚", 1200);
});

document.getElementById("btnMakeGridTemplate").addEventListener("click", ()=>{
  // ä¾ç›®å‰é¸æ“‡ç”¢ç”Ÿæ¨¡æ¿ï¼šè‹¥æ˜¯autoï¼Œé è¨­10
  const v = elCustomGridSize.value;
  const n = (v === "auto") ? 10 : Number(v);
  const line = "â–¡".repeat(n);
  elCustomGridText.value = Array.from({length:n}, ()=> line).join("\n");
  showToast("å·²ç”¢ç”Ÿæ¨¡æ¿", `è«‹å°‡ â–¡ æ›¿æ›æˆä½ è¦çš„å­—æ ¼å…§å®¹ï¼ˆ${n}Ã—${n}ï¼‰ã€‚`, 1800);
});

document.getElementById("btnUseBuiltin").addEventListener("click", ()=>{
  DB = structuredClone(BUILTIN);
  currentLessonIndex = 0;
  elCustomNote.textContent = "";
  showToast("å·²åˆ‡å›å…§å»ºé¡Œåº«", "å¯ç›´æ¥é–‹å§‹ç©ï¼ˆå·²é‡è¨­è¨ˆæ™‚ï¼‰ã€‚");
  startLesson(true);
});

btnLoadSaved.addEventListener("click", ()=>{
  const item = getSavedSelected();
  if(!item) return;
  elCustomLessonName.value = item.lesson;
  elCustomWords.value = item.words.join("\n");
  elCustomQuestion.value = item.question || "è«‹æ‰¾å‡ºä¸‹åˆ—èªè©";
  elCustomGridSize.value = (item.gridSizeMode ?? "auto");
  elCustomGridText.value = item.gridText || "";
  showToast("å·²è¼‰å…¥", `å·²å°‡ã€Œ${item.lesson}ã€å¸¶å…¥è¼¸å…¥æ¡†ã€‚`, 1400);
});

btnPlaySaved.addEventListener("click", ()=>{
  const item = getSavedSelected();
  if(!item) return;
  mergeSavedIntoDB();
  const idx = DB.lessons.findIndex(l => l._saved && l.lesson === item.lesson);
  if(idx >= 0){
    currentLessonIndex = idx;
    startLesson(true);
    renderLessons();
    showToast("é–‹å§‹æ­¤èª²", `å·²è¼‰å…¥ã€Œ${item.lesson}ã€ã€‚`, 1400);
  }
});

btnDeleteSaved.addEventListener("click", ()=>{
  const item = getSavedSelected();
  if(!item) return;
  try{
    deleteSavedLessonByName(item.lesson);
    refreshSavedSelect();
    mergeSavedIntoDB();
    renderLessons();
    showToast("å·²åˆªé™¤", `å·²å¾æœ¬æ©Ÿåˆªé™¤ã€Œ${item.lesson}ã€ã€‚`, 1600);
  }catch(err){
    showToast("åˆªé™¤å¤±æ•—", err.message || String(err), 2200);
  }
});

document.getElementById("btnNew").addEventListener("click", ()=> startLesson(true));
document.getElementById("btnReset").addEventListener("click", ()=> startLesson(false));

elGrid.addEventListener("pointerdown", onPointerDown);
elGrid.addEventListener("pointermove", onPointerMove);
elGrid.addEventListener("pointerup", onPointerUp);
elGrid.addEventListener("pointercancel", onPointerUp);

window.addEventListener("resize", ()=> { if(gridSize) setResponsiveCellSize(gridSize); });

function startApp(){
  mergeSavedIntoDB();
  refreshSavedSelect();
  renderLessons();
  renderTimer();
  startLesson(true);
}
startApp();
</script>
</body>
</html>
